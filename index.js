const departements_fr = [{
    "code": "01",
    "nom": "Ain"
},
{
    "code": "02",
    "nom": "Aisne"
},
{
    "code": "03",
    "nom": "Allier"
},
{
    "code": "04",
    "nom": "Alpes-de-Haute-Provence"
},
{
    "code": "05",
    "nom": "Hautes-Alpes"
},
{
    "code": "06",
    "nom": "Alpes-Maritimes"
},
{
    "code": "07",
    "nom": "Ardèche"
},
{
    "code": "08",
    "nom": "Ardennes"
},
{
    "code": "09",
    "nom": "Ariège"
},
{
    "code": "10",
    "nom": "Aube"
},
{
    "code": "11",
    "nom": "Aude"
},
{
    "code": "12",
    "nom": "Aveyron"
},
{
    "code": "13",
    "nom": "Bouches-du-Rhône"
},
{
    "code": "14",
    "nom": "Calvados"
},
{
    "code": "15",
    "nom": "Cantal"
},
{
    "code": "16",
    "nom": "Charente"
},
{
    "code": "17",
    "nom": "Charente-Maritime"
},
{
    "code": "18",
    "nom": "Cher"
},
{
    "code": "19",
    "nom": "Corrèze"
},
{
    "code": "",
    "nom": "Corse-du-Sud"
},
{
    "code": "",
    "nom": "Haute-Corse"
},
{
    "code": "21",
    "nom": "Côte-d'Or"
},
{
    "code": "22",
    "nom": "Côtes-d'Armor"
},
{
    "code": "23",
    "nom": "Creuse"
},
{
    "code": "24",
    "nom": "Dordogne"
},
{
    "code": "25",
    "nom": "Doubs"
},
{
    "code": "26",
    "nom": "Drôme"
},
{
    "code": "27",
    "nom": "Eure"
},
{
    "code": "28",
    "nom": "Eure-et-Loir"
},
{
    "code": "29",
    "nom": "Finistère"
},
{
    "code": "30",
    "nom": "Gard"
},
{
    "code": "31",
    "nom": "Haute-Garonne"
},
{
    "code": "32",
    "nom": "Gers"
},
{
    "code": "33",
    "nom": "Gironde"
},
{
    "code": "34",
    "nom": "Hérault"
},
{
    "code": "35",
    "nom": "Ille-et-Vilaine"
},
{
    "code": "36",
    "nom": "Indre"
},
{
    "code": "37",
    "nom": "Indre-et-Loire"
},
{
    "code": "38",
    "nom": "Isère"
},
{
    "code": "39",
    "nom": "Jura"
},
{
    "code": "40",
    "nom": "Landes"
},
{
    "code": "41",
    "nom": "Loir-et-Cher"
},
{
    "code": "42",
    "nom": "Loire"
},
{
    "code": "43",
    "nom": "Haute-Loire"
},
{
    "code": "44",
    "nom": "Loire-Atlantique"
},
{
    "code": "45",
    "nom": "Loiret"
},
{
    "code": "46",
    "nom": "Lot"
},
{
    "code": "47",
    "nom": "Lot-et-Garonne"
},
{
    "code": "48",
    "nom": "Lozère"
},
{
    "code": "49",
    "nom": "Maine-et-Loire"
},
{
    "code": "50",
    "nom": "Manche"
},
{
    "code": "51",
    "nom": "Marne"
},
{
    "code": "52",
    "nom": "Haute-Marne"
},
{
    "code": "53",
    "nom": "Mayenne"
},
{
    "code": "54",
    "nom": "Meurthe-et-Moselle"
},
{
    "code": "55",
    "nom": "Meuse"
},
{
    "code": "56",
    "nom": "Morbihan"
},
{
    "code": "57",
    "nom": "Moselle"
},
{
    "code": "58",
    "nom": "Nièvre"
},
{
    "code": "59",
    "nom": "Nord"
},
{
    "code": "60",
    "nom": "Oise"
},
{
    "code": "61",
    "nom": "Orne"
},
{
    "code": "62",
    "nom": "Pas-de-Calais"
},
{
    "code": "63",
    "nom": "Puy-de-Dôme"
},
{
    "code": "64",
    "nom": "Pyrénées-Atlantiques"
},
{
    "code": "65",
    "nom": "Hautes-Pyrénées"
},
{
    "code": "66",
    "nom": "Pyrénées-Orientales"
},
{
    "code": "67",
    "nom": "Bas-Rhin"
},
{
    "code": "68",
    "nom": "Haut-Rhin"
},
{
    "code": "69",
    "nom": "Rhône"
},
{
    "code": "70",
    "nom": "Haute-Saône"
},
{
    "code": "71",
    "nom": "Saône-et-Loire"
},
{
    "code": "72",
    "nom": "Sarthe"
},
{
    "code": "73",
    "nom": "Savoie"
},
{
    "code": "74",
    "nom": "Haute-Savoie"
},
{
    "code": "75",
    "nom": "Paris"
},
{
    "code": "76",
    "nom": "Seine-Maritime"
},
{
    "code": "77",
    "nom": "Seine-et-Marne"
},
{
    "code": "78",
    "nom": "Yvelines"
},
{
    "code": "79",
    "nom": "Deux-Sèvres"
},
{
    "code": "80",
    "nom": "Somme"
},
{
    "code": "81",
    "nom": "Tarn"
},
{
    "code": "82",
    "nom": "Tarn-et-Garonne"
},
{
    "code": "83",
    "nom": "Var"
},
{
    "code": "84",
    "nom": "Vaucluse"
},
{
    "code": "85",
    "nom": "Vendée"
},
{
    "code": "86",
    "nom": "Vienne"
},
{
    "code": "87",
    "nom": "Haute-Vienne"
},
{
    "code": "88",
    "nom": "Vosges"
},
{
    "code": "89",
    "nom": "Yonne"
},
{
    "code": "90",
    "nom": "Territoire de Belfort"
},
{
    "code": "91",
    "nom": "Essonne"
},
{
    "code": "92",
    "nom": "Hauts-de-Seine"
},
{
    "code": "93",
    "nom": "Seine-Saint-Denis"
},
{
    "code": "94",
    "nom": "Val-de-Marne"
},
{
    "code": "95",
    "nom": "Val-d'Oise"
},
{
    "code": "971",
    "nom": "Guadeloupe"
},
{
    "code": "972",
    "nom": "Martinique"
},
{
    "code": "973",
    "nom": "Guyane"
},
{
    "code": "974",
    "nom": "La Réunion"
},
{
    "code": "976",
    "nom": "Mayotte"
}
]
const departements_fr_urls = null
let autoLoop = false
let localStorageKey = ''
let txtarea = null
let contacts = {
    quoiqui: "medecin generaliste",
    ou: "Aube (10)",
    univers: "pagesjaunes",
    idOu: "D010",
    list: []
}

/////////////////////////////////////////////////////////////////////////
// FUNCTIONS
/////////////////////////////////////////////////////////////////////////

// function setNewPersistentQuery() {
//     let p = prompt('Quelle est votre nouvelle requête ?', contacts.quoiqui)
//     if (p.length > 0 && p != contacts.quoiqui) {
//         contacts.quoiqui = p
//         setFullListInLocalStorage()
//         alert('✅ Nouvelle requête sauvegardée !')
//     } else {
//         alert('❌ Mauvaise requête !!!')
//     }
// }


function getAutoLoopFromLocalStorage() {
    let x = JSON.parse(localStorage.getItem('auto_extraction_of_pages_jaunes'))
    if (x == null) {
        localStorage.setItem('auto_extraction_of_pages_jaunes', false)
        autoLoop = false
        debugger
    } else {
        autoLoop = x
        debugger
    }
}

function setLocalStorageKey(text) {
    return '_crawler_query_' + text.replace(/\s/g, '_')
}

function getFullListFromLocalStorage() {
    let queries = getActualQueryURL()
    if (queries.hasOwnProperty('quoiqui') == false) return
    let dataLocal = JSON.parse(localStorage.getItem(setLocalStorageKey(queries.quoiqui)))
    debugger
    if (dataLocal) {
        contacts = dataLocal
        if (autoLoop) {
            extractAllData()
        }
    } else {
        contacts = {
            ...queries,
            list: []
        }
    }
}

function setFullListInLocalStorage() {
    localStorage.setItem(setLocalStorageKey(contacts.quoiqui), JSON.stringify(contacts))
}

function getActualQueryURL() {
    var obj = {}
    decodeURI(window.location.search).substring(1)
        .split(/\?|&/g)
        .forEach(x => {
            let sp = x.split('=')
            let key = sp[0]
            obj[key] = sp[1].replace(/\+/g, ' ')
        })
    return obj
}

function insertTextArea() {
    let elm = document.querySelector("#pave1")

    if (elm == null) return
    if (txtarea != null) return

    txtarea = document.createElement('textarea')
    txtarea.id = 'clipboard-txtarea'
    txtarea.style.cssText = `
        position: fixed;
        top: 0;
        right: -50%;
    `
    elm.append(txtarea)
}

function insertButton(config) {
    let elm = document.querySelector("#pave1")

    if (elm == null) return
    if (document.querySelector("#" + config.id) != null) return

    btn = document.createElement('button')
    btn.innerText = config.innerText
    btn.id = config.id
    btn.style.cssText = `
        margin-top: 1.3rem;
        width: 100%;
        background-color:${config.backgroundColor};
        border-radius:13px;
        border:3px solid ${config.borderColor};
        display:inline-block;
        cursor:pointer;
        color:${config.color};
        font-family:Trebuchet MS;
        font-size:20px;
        padding:16px 31px;
        text-decoration:none;
        text-shadow:0px 1px 0px #333333;
    `
    btn.onclick = config.fx

    elm.append(btn)
}

function extractAllData() {
    // always update "contacts" queries setup
    let queries = getActualQueryURL()
    contacts.ou = queries.ou //"Aube (10)"
    contacts.idOu = queries.idOu //"D010"
    contacts.list = contacts.list.concat(getLis())

    // remove duplications
    contacts.list = contacts.list
        .reduce((accum, curr) => {
            if (accum.indexOf(curr) === -1) {
                accum.push(curr)
            }
            return accum
        }, [])
    setFullListInLocalStorage()
    goToNext()
}

function autoExecutionUntilLastPage() {
    autoLoop = JSON.parse(localStorage.getItem('auto_extraction_of_pages_jaunes'))
    if (autoLoop == false) {
        let extractAll = prompt('Extraire toutes les pages restantes ? O ou N')
        if (extractAll == 'O') {
            localStorage.setItem('auto_extraction_of_pages_jaunes', true)
        } else {
            localStorage.setItem('auto_extraction_of_pages_jaunes', false)
        }
        autoLoop = JSON.parse(localStorage.getItem('auto_extraction_of_pages_jaunes'))
    }
}

function getLis() {
    let results = []
    let lis = document.querySelectorAll('.bi-bloc.blocs')
    debugger
    lis.forEach(li => {
        let img = li.querySelector('IMG') ? li.querySelector('IMG').src : ''
        let title = li.querySelector('H3').innerText
        //
        let adress = li.querySelector('.adresse-container a').innerText.split('\n')[0].match(/(^.+[,])|(?:.+\d{5}\s)|([^\d]+.+$)/gmi)
        let street = adress[0].replace(/,$/g, '').trim()
        let postalCode = adress[1].replace(/\s/g, '').trim()
        let city = adress[2].trim()
        //
        let email = ''
        let websites = Array.from(li.querySelectorAll('.bi-sites-internet li a[data-pjlb]')).map(x => window.atob(JSON.parse(x.dataset.pjlb).url))
        let phones = Array.from(li.querySelectorAll('.bi-contact-numbers .num')).map(x => {
            let val = x.innerText.trim()
            let key = val.match(/^06|^07/) ? 'mobile' : 'fixe'
            return {
                [key]: val
            }
        })

        let obj = {
            img,
            title,
            street,
            postalCode,
            city,
            email,
            websites,
            phones,
            notes: '',
            firstCallDate: '',
            feelingScore: 0, // from 1 to 5
        }
        results.push(obj)
    })

    return results

}

function goToNext() {

    autoExecutionUntilLastPage()
    let elm = document.querySelector("#pagination-next")
    let next = elm ? window.atob(JSON.parse(elm.dataset.pjlb).url) : false
    setTimeout(() => {
        if (next) {
            debugger
            window.location.href = next
        } else {
            localStorage.setItem('auto_extraction_of_pages_jaunes', false)
            console.log('Liste complète des contacts PJ : \n', contacts)
            alert('Tous les contacts de ce lieu ont été enregistrés')
            debugger
            goToNextDepartment()
        }
    }, 1333 + Math.round(1333 * Math.random()));
}

function goToNextDepartment() {
    let queries = getActualQueryURL()
    let newCode = +queries.ou.match(/\d+/)[0] + 1
    let result = departements_fr.find(x => +x.code >= newCode)
    debugger
    if (result.code < 976) {
        const { nom, code } = result
        const q = contacts.quoiqui.replace(/\s+/g, '+')
        //"https://www.pagesjaunes.fr/annuaire/chercherlespros?quoiqui=medecin+generaliste&ou=Ardèche+(07)&univers=pagesjaunes&idOu=D007"
        let url = `https://www.pagesjaunes.fr/annuaire/chercherlespros?quoiqui=${q}&ou=${nom}+(${code})&univers=pagesjaunes&idOu=D${code.toString().padStart(3, 0)}`
        window.location.href = encodeURI(url)
    } else {
        alert('🟦 Tous les contacts de tous les départements français ont été enregistrés.')
    }
}

function copyClipboard() {
    /* Get the text field */
    var copyText = document.getElementById("clipboard-txtarea");

    /** Set data into textarea  */
    copyText.value = JSON.stringify(contacts)

    /* Select the text field */
    copyText.select();
    copyText.setSelectionRange(0, 99999); /* For mobile devices */

    /* Copy the text inside the text field */
    document.execCommand("copy");

    /* Alert the copied text */
    alert("Copied the text: " + copyText.value);
}


/////////////////////////////////////////////////////////////////////////
// executions
/////////////////////////////////////////////////////////////////////////

getAutoLoopFromLocalStorage()
getFullListFromLocalStorage()
// insertButton({
//     id: 'set-query',
//     innerText: 'Set new persistent query',
//     color: '#ffffff',
//     backgroundColor: '#DAAADB',
//     borderColor: '#7A297B',
//     fx: setNewPersistentQuery
// })
insertButton({
    id: 'extract-contacts',
    innerText: 'Extract all contacts',
    color: '#ffffff',
    backgroundColor: '#44c767',
    borderColor: '#18ab29',
    fx: extractAllData
})
insertButton({
    id: 'copy-report-clipboard',
    innerText: 'Copy contact report to clipboard',
    color: '#ffffff',
    backgroundColor: '#7A81DE',
    borderColor: '#101566',
    fx: copyClipboard
})
insertTextArea()




/////////////////////////////////////////////////////////////////////////
// executions
/////////////////////////////////////////////////////////////////////////